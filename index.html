<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4HM Jank-O-Meter — Themed + Mobile + Log Slider + Janki-ness Score</title>

  <!-- Data & table libs (defer to avoid race conditions) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>

  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root { --bg:#fdf6e3; --card:#f9f2dd; --ink:#2b1a08; --muted:#7c6a4c; --accent:#8b4513; }

    /* === PAGE BACKGROUND WITH EMBEDDED BORDER (SVG data URI) === */
    html, body {
      margin:0; padding:0; min-height:100%; box-sizing:border-box;
      background: var(--bg);
      color:var(--ink);
      font:16px/1.5 "Book Antiqua", Palatino, serif;
    }
    body {
      /* Faux parchment texture using layered gradients */
      background-image:
        radial-gradient(1200px 700px at 20% 10%, #fff9e6, rgba(0,0,0,0) 70%),
        radial-gradient(1000px 600px at 80% 20%, #f8edd4, rgba(0,0,0,0) 70%),
        radial-gradient(1400px 800px at 50% 90%, #f3e4c1, rgba(0,0,0,0) 70%),
        linear-gradient(#fdf6e3, #fdf6e3);
      /* Decorative border using an inline SVG strip as border-image */
      border:40px solid transparent;
      border-image-source: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3e%3crect width='80' height='80' fill='%23d6b87a'/%3e%3cg opacity='0.25'%3e%3ccircle cx='10' cy='10' r='2' fill='%238d6e3f'/%3e%3ccircle cx='40' cy='20' r='1.6' fill='%238d6e3f'/%3e%3ccircle cx='65' cy='12' r='1.8' fill='%238d6e3f'/%3e%3ccircle cx='20' cy='55' r='2' fill='%238d6e3f'/%3e%3ccircle cx='70' cy='60' r='1.4' fill='%238d6e3f'/%3e%3cpath d='M0 0h80v80H0z' fill='none' stroke='%23b89654' stroke-width='2'/%3e%3c/g%3e%3c/svg%3e");
      border-image-slice: 100;
      border-image-repeat: round;
    }

    /* === Faint 4HM watermark (inline SVG as background) === */
    body::after {
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background: center/600px no-repeat url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='800' height='800' viewBox='0 0 800 800'%3e%3cdefs%3e%3clinearGradient id='g' x1='0' x2='0' y1='0' y2='1'%3e%3cstop offset='0' stop-color='%23b89654'/%3e%3cstop offset='1' stop-color='%238d6e3f'/%3e%3c/linearGradient%3e%3c/defs%3e%3cg opacity='0.08'%3e%3ccircle cx='400' cy='400' r='300' fill='url(%23g)'/%3e%3ctext x='400' y='430' text-anchor='middle' font-size='220' font-family='Georgia, serif' fill='%23000'%3e4HM%3c/text%3e%3cpath d='M170 320c50 -90 230 -90 280 0' fill='none' stroke='%23000' stroke-width='14' stroke-linecap='round'/%3e%3cpath d='M350 320c50 -90 230 -90 280 0' fill='none' stroke='%23000' stroke-width='14' stroke-linecap='round'/%3e%3c/g%3e%3c/svg%3e");
    }

    /* === STAGING ribbon (visible) === */
    .ribbon { position:fixed; top:8px; right:-50px; transform:rotate(45deg); background:#b91c1c; color:#fff; padding:6px 60px; z-index:9999; font:600 14px system-ui; box-shadow:0 2px 6px rgba(0,0,0,0.3); }

    /* === Header parchment scroll === */
    header {
      background: radial-gradient(circle at top left, #fff9e6, #fdf6e3 60%, #f3e4c1);
      border-bottom:4px solid #d6b87a; border-top:4px solid #d6b87a;
      box-shadow:0 4px 12px rgba(0,0,0,0.35);
      padding:24px 16px; text-align:center; position:relative; z-index:1;
    }
    header h1 { margin:0; font-size:32px; color:#3a240a; text-shadow:1px 1px 0 #fff; }
    header .sub { margin-top:6px; font-size:15px; color:#5a3816; }

    .wrap { max-width:1100px; margin:20px auto 60px; padding:0 16px; position:relative; z-index:1; }
    .panel { background:var(--card); border-radius:16px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.25); }
    .controls { display:grid; gap:12px; grid-template-columns: 1fr; align-items:center; }
    .row { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .pill { background:#f2e6c6; border:1px solid #c8a96c; color:var(--ink); padding:8px 12px; border-radius:999px; display:inline-flex; align-items:center; gap:10px; }

    /* === Brass slider (cross-browser) === */
    input[type="range"] { -webkit-appearance:none !important; appearance:none !important; width:260px; height:10px; border-radius:5px; background:linear-gradient(to right, #d6b87a, #b38b4d); outline:none; margin:0 8px; cursor:pointer; border:1px solid #8b5a2b; box-shadow:inset 0 0 4px rgba(0,0,0,.4); }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none !important; appearance:none !important; width:20px; height:20px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #d6b87a, #8b5a2b); border:2px solid #5c3b16; box-shadow:inset 0 0 6px #d6b87a, 0 0 2px #000; cursor:pointer; transition:transform .05s ease-in-out; }
    input[type="range"]:active::-webkit-slider-thumb { transform:scale(1.05); }
    input[type="range"]::-moz-range-thumb { width:20px; height:20px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #d6b87a, #8b5a2b); border:2px solid #5c3b16; box-shadow:inset 0 0 6px #d6b87a, 0 0 2px #000; cursor:pointer; transition:transform .05s ease-in-out; }
    input[type="range"]:active::-moz-range-thumb { transform:scale(1.05); }
    input[type="range"]::-ms-thumb { width:20px; height:20px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #d6b87a, #8b5a2b); border:2px solid #5c3b16; box-shadow:inset 0 0 6px #d6b87a, 0 0 2px #000; cursor:pointer; }

    #thresholdNumber { width:90px; background:#fff9e6; color:#2b1a08; border:2px solid #c8a96c; border-radius:8px; padding:6px 8px; font-family:'Book Antiqua', Palatino, serif; box-shadow:inset 0 0 5px #d6b87a; }

    .muted { color:var(--muted); font-size:13px; }
    .kpi { font-weight:700; color:var(--accent); }
    .actions { margin-left:auto; display:flex; gap:10px; }
    .btn { background:#fdf6e3; border:1px solid #c8a96c; color:#3a240a; padding:8px 12px; border-radius:10px; cursor:pointer; font-family:"Book Antiqua", Palatino, serif; }
    .btn:hover { background:#f8edd4; }
    .btn-mini { padding: 4px 8px; font-size: 13px; border-radius: 8px; }
    #quickPresets { gap: 6px; }

    /* === Table parchment skin === */
    table.dataTable { background:#fdf6e3; border:2px solid #d6b87a; border-radius:12px; overflow:hidden; }
    table.dataTable thead th { background:#f2e6c6; color:#3a240a; font-weight:bold; border-bottom:2px solid #d6b87a; }
    table.dataTable tbody tr:nth-child(even) { background:#fbf2de; }
    table.dataTable tbody tr:nth-child(odd)  { background:#f6ebd2; }
    table.dataTable tbody td { color:#2b1a08; }
    a, a:visited { color:#7a3e00; }

    /* === About box parchment === */
    #about { margin-top:20px; font-size:14px; line-height:1.5; color:#2b1a08; background:#fdf6e3; border:2px solid #d6b87a; border-radius:12px; padding:16px; box-shadow: inset 0 0 12px rgba(0,0,0,0.25), 0 4px 12px rgba(0,0,0,0.25); background-image: radial-gradient(circle at top left, #fff9e6, #fdf6e3 60%, #f3e4c1); }
    #about b { color:#3a240a; }
    #about a { color:#7a3e00; font-weight:600; }
    #about a:hover { color:#a75500; }

    /* === Inline error banner (for quick diagnosis) === */
    #err { display:none; margin-top:12px; padding:10px 12px; border-radius:10px; background:#ffe6e6; color:#7a0000; border:1px solid #d88; }

    /* === Mobile polish === */
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    #jankTable { table-layout: fixed; }
    #jankTable th, #jankTable td { white-space: normal; word-break: break-word; }

    @media (max-width: 640px) {
      body { border-width: 16px; }
      header h1 { font-size: 24px; }
      header .sub { font-size: 13px; }
      .wrap { padding: 0 8px; }
      .panel { border-radius: 12px; padding: 12px; }
      .pill { padding: 6px 8px; }
      input[type="range"] { width: 100%; }
      #thresholdNumber { width: 72px; }
      table.dataTable { border-width: 1px; }
      table.dataTable thead th { font-size: 14px; }
      table.dataTable tbody td { font-size: 14px; }
    }
    @media (max-width: 380px) {
      body { border-width: 10px; }
      header h1 { font-size: 20px; }
      .pill { border-radius: 14px; }
    }

    /* === Deck Score styles === */
    #scorePanel .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    #deckInput { width:100%; min-height:180px; box-sizing:border-box; background:#fff9e6; border:2px solid #c8a96c; border-radius:12px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .score-hero { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
    .score-badge { background:#f2e6c6; border:1px solid #c8a96c; padding:10px 14px; border-radius:12px; }
    .meter { height:12px; background:#eadfbe; border:1px solid #c8a96c; border-radius:999px; overflow:hidden; }
    .meter > div { height:100%; background:linear-gradient(90deg,#6bcb6b,#ffd166,#ff9248,#ef476f); width:0%; }
    .small { font-size:13px; color:#5a3816; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .list { margin:6px 0 0 16px; }

    /* Mobile-friendly details toggle for formula */
    details.formula-toggle{margin-top:6px}
    details.formula-toggle summary{cursor:pointer; padding:8px 0; outline:none; list-style:none}
    details.formula-toggle summary::-webkit-details-marker{display:none}
    .chev{display:inline-block; transform:rotate(0deg); transition:transform .2s ease}
    details[open] .chev{transform:rotate(90deg)}
  </style>
</head>
<body>
  <div class="ribbon">STAGING</div>
  <header>
    <h1>⚡ 4HM Jank-O-Meter ⚡</h1>
    <div class="sub">Slide to set a maximum <b>Total Appearances</b>. Cards at or below the threshold are tagged as <i>Jank</i> (rarely used). Now with <b>Janki-ness Score (Beta)</b>.</div>
  </header>

  <div class="wrap">
    <!-- JANK FILTER PANEL -->
    <div class="panel">
      <div class="controls">
        <div class="row">
          <div class="pill" title="Set the maximum total appearances to include">
            <span>Threshold ≤ <span id="thresholdLabel" class="kpi">…</span></span>
            <input id="threshold" type="range" min="0" max="100" value="5" step="1"/>
            <input id="thresholdNumber" type="number" min="0" value="5" step="1" title="Type an exact threshold"/>
          </div>
          <div class="pill" id="quickPresets" title="Quick jank thresholds">
            Quick:
            <button class="btn btn-mini" data-th="1">≤1</button>
            <button class="btn btn-mini" data-th="2">≤2</button>
            <button class="btn btn-mini" data-th="3">≤3</button>
            <button class="btn btn-mini" data-th="4">≤4</button>
            <button class="btn btn-mini" data-th="8">≤8</button>
          </div>
          <div class="pill" title="Filter results by set">
            <label for="setFilter" class="muted">Filter by Set:</label>
            <select id="setFilter" style="background:#fff9e6; color:#2b1a08; border:1px solid #c8a96c; border-radius:8px; padding:6px 8px;">
              <option value="">All Sets</option>
            </select>
          </div>
          <div class="actions">
            <button id="exportBtn" class="btn" title="Download the current jank list as CSV">Export CSV</button>
            <button id="copyLinkBtn" class="btn" title="Copy a sharable link with your current settings">Copy Sharable Link</button>
          </div>
        </div>
        <div class="muted" id="meta">Loading data…</div>
        <div id="err"></div>
      </div>
    </div>

    <!-- TABLE PANEL -->
    <div class="panel" style="margin-top:16px;">
      <div class="table-wrap">
        <table id="jankTable" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Set Name</th>
              <th>Card Name</th>
              <th>Main Deck</th>
              <th>Sideboard</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="about">
        <p><b>About Jank-O-Meter:</b> This tool defines <i>Jank</i> as any legal 4HM card that has appeared in tournament decks fewer times than the chosen threshold. Adjust the slider to reveal the deepest jank of the format.</p>
        <p>📊 <b>Data Source:</b> <a href="https://docs.google.com/spreadsheets/d/1hrPpYnM7QcIL8IEz03ZZn0cUiRIAtAaBIRk1g6ru-1s/edit?usp=sharing" target="_blank" rel="noopener">4HM Tournament Card Usage Sheet</a> (Google Sheets, live CSV). Big thanks to <b>Jim</b> for compiling/cleaning the data.</p>
        <p id="lastUpdated">⏱️ <b>Last updated:</b> …</p>
      </div>
    </div>

    <!-- JANKI-NESS SCORE (BETA) -->
    <div class="panel" id="scorePanel" style="margin-top:16px;">
      <h2 style="margin:0 0 10px 0; color:#3a240a;">🧪 Janki-ness Score (Beta)</h2>
      <div class="grid">
        <div>
          <label for="deckInput" class="muted">Paste your Tolaria/ManaStack/Moxfield-style list here (sideboard optional):</label>
          <textarea id="deckInput" placeholder="e.g. 

3 Sword of the Ages 
1 Sylvan Library 
1 Vaevictis Asmadi
...            

SIDEBOARD:
1 Bazaar of Baghdad 
3 Crumble
..."></textarea>
          <div class="small">or <input type="file" id="deckFile" accept=".txt,.dek,.dec"/> <button id="analyzeBtn" class="btn">Analyze Deck</button>
            <label style="margin-left:8px;"><input type="checkbox" id="includeSb"/> Include sideboard in score</label>
          </div>
        </div>
        <div class="score-hero">
          <div class="score-badge">
            <div><b>Janki-ness Score</b> <span id="scoreValue" class="kpi">—</span>/100</div>
            <div class="meter" aria-hidden="true"><div id="scoreBar"></div></div>
            <div id="scoreFlavor" class="small">Paste a deck to score it.</div>
          </div>
          <div class="score-badge" style="min-width:260px;">
            <div><b>Badges</b></div>
            <div id="badges" class="small">—</div>
            <!-- Friendly blurb + toggle for the exact formula -->
            <p class="small" style="margin:6px 0 0 0;">The score rewards decks that run oddball, rarely‑seen cards and penalizes heavy reliance on common staples. Extra credit is given when a high percentage of the deck is made up of these unusual picks. <i>In short: the rarer and denser the jank, the higher the score.</i></p>
            <details class="formula-toggle small"><summary><span class="chev">▸</span> Show exact formula</summary>
              <div><span class="mono">Score = clamp(Base + Bonus, 0..100). Base = 100 × ((Σ copies×weight)/6000). weight = 100 × (1 − log(Total+1)/log(Max+1)). Bonus = round(25 × (JankDensity/100)^1.1).</span></div>
            </details>
          </div>
        </div>
        <div class="score-badge" style="flex:1;">
          <div><b>Top 5 Jankiest in Deck</b></div>
          <ol id="topJank" class="list"></ol>
        </div>
        <div class="score-badge" style="flex:1;">
          <div><b>Unmatched / Notes</b></div>
          <ul id="notes" class="list"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Live CSV published from Google Sheets
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8EjG79BHZiJz5qpnb8cMTN3R_3j_pbKlNODR3iggZhSF9VaKjjWNRle6DVkqGMBOlo0YyoTbW7vjX/pub?gid=0&single=true&output=csv";

    let allRows = []; let dataTable = null; let MAX_TOTAL = 0;
    const params = new URLSearchParams(location.search);

    // Log mapping helpers: slider [0..100] <-> absolute threshold [0..MAX_TOTAL]
    function sliderToThreshold(s){ const k = Math.log(MAX_TOTAL + 1) / 100; return Math.round(Math.exp(k * s) - 1); }
    function thresholdToSlider(t){ const k = Math.log(MAX_TOTAL + 1) / 100; return Math.round(Math.log((t||0) + 1) / k); }

    window.addEventListener('DOMContentLoaded', () => { boot(); });

    function showErr(msg){
      console.error(msg);
      const el = document.getElementById('err');
      el.style.display = 'block';
      el.textContent = typeof msg === 'string' ? msg : (msg && msg.message ? msg.message : JSON.stringify(msg));
    }

    function boot(){
      try {
        Papa.parse(CSV_URL, {
          download: true,
          header: true,
          skipEmptyLines: 'greedy',
          complete: onCSV,
          error: (err) => { showErr('CSV load error: '+err); fallbackFetch(); }
        });
      } catch(e){ showErr('Papa.parse threw: '+ e); fallbackFetch(); }
    }

    function fallbackFetch(){
      fetch(CSV_URL).then(r=>r.text()).then(csv => {
        const res = Papa.parse(csv, {header:true, skipEmptyLines:'greedy'});
        onCSV(res);
      }).catch(err => showErr('Fetch fallback failed: '+err));
    }

    function onCSV(res){
      if (!res || !res.data) { showErr('No data parsed from CSV.'); return; }
      allRows = res.data
        .filter(r => r && r["Card Name"]) // drop empties & header repeats
        .map(r => ({
          set: String(r["Set Name"]).trim(),
          card: String(r["Card Name"]).trim(),
          main: Number(r["Main Deck"]) || 0,
          side: Number(r["Sideboard"]) || 0,
          total: Number(r["Total"]) || 0,
        }));

      MAX_TOTAL = allRows.reduce((m, r) => Math.max(m, r.total), 0);
      const qThreshold = params.get('max');
      const qSet = params.get('set');
      const initialAbs = Math.min(qThreshold ? Number(qThreshold) : 4, MAX_TOTAL);

      initUI(initialAbs);
      populateSetFilter(allRows.map(r => r.set));
      renderTable(initialAbs, qSet);

      const uniques = new Set(allRows.map(r => `${r.set}||${r.card}`)).size;
      document.getElementById('meta').textContent = `Loaded ${allRows.length.toLocaleString()} rows (${uniques.toLocaleString()} unique cards). Max Total = ${MAX_TOTAL.toLocaleString()}.`;
      document.getElementById('lastUpdated').innerHTML = `⏱️ <b>Last updated:</b> ${new Date().toLocaleString()}`;

      // Deck Score binder
      bindDeckScore();
    }

    function clampNumber(v, min, max){ return Math.max(min, Math.min(max, v)); }

    function initUI(initialAbs){
      const slider = document.getElementById('threshold');
      const box = document.getElementById('thresholdNumber');
      const label = document.getElementById('thresholdLabel');

      // Slider always 0..100 (log scale), box is absolute 0..MAX_TOTAL
      slider.min = "0"; slider.max = "100"; slider.value = String(thresholdToSlider(initialAbs));
      box.min = "0"; box.max = String(MAX_TOTAL); box.value = String(initialAbs);
      label.textContent = Number(initialAbs).toLocaleString();

      const syncFromSlider = (sVal) => {
        const abs = sliderToThreshold(Number(sVal));
        box.value = String(abs);
        label.textContent = abs.toLocaleString();
        renderTable(abs, document.getElementById('setFilter').value || "");
        updateQuery(abs, document.getElementById('setFilter').value || "");
      };

      const syncFromBox = (bVal) => {
        const abs = clampNumber(Number(bVal)||0, 0, MAX_TOTAL);
        slider.value = String(thresholdToSlider(abs));
        label.textContent = abs.toLocaleString();
        renderTable(abs, document.getElementById('setFilter').value || "");
        updateQuery(abs, document.getElementById('setFilter').value || "");
      };

      slider.addEventListener('input', e => syncFromSlider(e.target.value));
      box.addEventListener('input',   e => syncFromBox(e.target.value));

      document.getElementById('setFilter').addEventListener('change', () => {
        const abs = Number(box.value);
        renderTable(abs, document.getElementById('setFilter').value || "");
        updateQuery(abs, document.getElementById('setFilter').value || "");
      });

      document.getElementById('exportBtn').addEventListener('click', exportCSV);
      document.getElementById('copyLinkBtn').addEventListener('click', copySharableLink);

      // Quick preset buttons
      document.querySelectorAll('#quickPresets .btn-mini').forEach(b => {
        b.addEventListener('click', () => {
          const abs = Math.min(Number(b.dataset.th), MAX_TOTAL);
          box.value = String(abs);
          slider.value = String(thresholdToSlider(abs));
          label.textContent = abs.toLocaleString();
          renderTable(abs, document.getElementById('setFilter').value || "");
          updateQuery(abs, document.getElementById('setFilter').value || "");
        });
      });
    }

    function populateSetFilter(sets){
      const sel = document.getElementById('setFilter');
      const uniq = Array.from(new Set(sets)).sort((a,b)=>a.localeCompare(b));
      uniq.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s; sel.appendChild(opt); });
      const qSet = params.get('set'); if (qSet) sel.value = qSet;
    }

    function renderTable(threshold, setFilter){
      const rows = allRows.filter(r => r.total <= threshold && (!setFilter || r.set === setFilter));
      const data = rows.map(r => [r.set, r.card, r.main, r.side, r.total]);

      if (dataTable){ dataTable.clear().rows.add(data).draw(); return; }

      if (!window.jQuery || !jQuery.fn || !jQuery.fn.DataTable){ showErr('DataTables failed to load. Check CDN availability.'); return; }

      dataTable = jQuery('#jankTable').DataTable({
        data,
        columns: [
          { title: 'Set Name' },
          { title: 'Card Name' },
          { title: 'Main Deck' },
          { title: 'Sideboard' },
          { title: 'Total' }
        ],
        order: [[4, 'asc'], [0, 'asc'], [1, 'asc']],
        pageLength: 25,
        deferRender: true,
        dom: 'tip'
      });
    }

    function exportCSV(){
      const v = Number(document.getElementById('thresholdNumber').value);
      const set = document.getElementById('setFilter').value || '';
      const rows = allRows.filter(r => r.total <= v && (!set || r.set === set));
      const header = ['Set Name','Card Name','Main Deck','Sideboard','Total'];
      const lines = [header.join(',')].concat(rows.map(r => [r.set, r.card, r.main, r.side, r.total].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `4HM-jank-threshold-${v}${set?`-${set.replace(/\s+/g,'_')}`:''}.csv`; a.click();
    }

    function updateQuery(max, set){
      const url = new URL(location.href);
      if (max != null) url.searchParams.set('max', String(max));
      if (set) url.searchParams.set('set', set); else url.searchParams.delete('set');
      history.replaceState(null, '', url);
    }

    async function copySharableLink(){
      try { await navigator.clipboard.writeText(location.href); alert('Sharable link copied to clipboard!'); }
      catch(e){ alert('Copy failed. You can manually copy the URL from the address bar.'); }
    }

    // ======================
    // Janki-ness Score (Beta)
    // ======================

    function bindDeckScore(){
      const ta = document.getElementById('deckInput');
      const file = document.getElementById('deckFile');
      const btn = document.getElementById('analyzeBtn');
      const includeSb = document.getElementById('includeSb');

      file.addEventListener('change', async () => {
        const f = file.files && file.files[0];
        if (!f) return;
        const text = await f.text();
        ta.value = text; // show in textarea
      });

      btn.addEventListener('click', () => {
        const text = (ta.value || '').trim();
        if (!text){
          alert('Paste a decklist first.');
          return;
        }
        const parsed = parseDeck(text);
        const report = scoreDeck(parsed, includeSb.checked);
        renderDeckScore(report);
      });
    }

    // Normalize names for matching
    function normName(s){
      return String(s || '')
        .normalize('NFKD')
        .replace(/[\u2018\u2019\u201A\u201B\u2032]/g, "'") // curly → straight apostrophes
        .replace(/[\u201C\u201D\u201E\u201F\u2033]/g, '"') // curly quotes
        .replace(/[\u2013\u2014]/g, '-') // en/em dash → hyphen
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
    }

    function buildNameMap(){
      const map = new Map();
      for (const r of allRows){
        const key = normName(r.card);
        if (!map.has(key)) map.set(key, r.card); // first seen wins (official name)
      }
      return map;
    }

    const NAME_MAP = () => buildNameMap();

    // Parse Tolaria/Moxfield-like list with optional SIDEBOARD:
    function parseDeck(text){
      const lines = text.split(/\r?\n/);
      const main = new Map();
      const side = new Map();
      let toSide = false;
      for (let raw of lines){
        const line = raw.trim();
        if (!line) continue;
        if (/^side\s*board\s*:?/i.test(line)) { toSide = true; continue; }
        // Format: "<count> <card name>" (count optional→ default 1 if starts with a name)
        const m = line.match(/^(\d+)?\s*(.+)$/);
        if (!m) continue;
        let n = m[1] ? parseInt(m[1],10) : 1;
        let name = m[2];
        // drop set codes like "[LEB]" or parentheses suffixes sometimes exported
        name = name.replace(/\[[^\]]+\]/g,'').replace(/\([^\)]*\)$/,'').trim();
        const bucket = toSide ? side : main;
        bucket.set(name, (bucket.get(name)||0) + (isFinite(n)?n:1));
      }
      return {main, side};
    }

    // === Jank tiers ===
    const THRESH_ULTRA = 1;   // 🧿 Ultra
    const THRESH_DEEP  = 4;   // 💀 Deep
    const THRESH_MED   = 10;  // 🧪 Medium
    const THRESH_LIGHT = 20;  // 🔥 Light

    function scoreDeck(parsed, includeSide){
      const nameMap = NAME_MAP();
      const toRow = new Map(); // officialName -> dataset row
      for (const r of allRows){ toRow.set(r.card, r); }

      // Expand map to array of {name,count}
      function mapToArr(m){ return Array.from(m.entries()).map(([name,count])=>({name, count})); }

      const mainArr = mapToArr(parsed.main);
      const sideArr = mapToArr(parsed.side);

      // Match against dataset
      const matchedMain = [];
      const unmatched = [];
      function matchArr(arr, tag){
        for (const item of arr){
          const key = normName(item.name);
          const official = nameMap.get(key);
          if (!official){ unmatched.push(`${tag}: ${item.count} × ${item.name}`); continue; }
          const row = toRow.get(official);
          if (!row){ unmatched.push(`${tag}: ${item.count} × ${item.name}`); continue; }
          matchedMain.push({ official, total: row.total, count: item.count });
        }
      }

      matchArr(mainArr, 'Main');
      const matchedSide = [];
      function matchSideArr(arr){
        for (const item of arr){
          const key = normName(item.name);
          const official = nameMap.get(key);
          if (!official){ unmatched.push(`Side: ${item.count} × ${item.name}`); continue; }
          const row = toRow.get(official);
          if (!row){ unmatched.push(`Side: ${item.count} × ${item.name}`); continue; }
          matchedSide.push({ official, total: row.total, count: item.count });
        }
      }
      matchSideArr(sideArr);

      // Jank weight per copy
      const logMax = Math.log(MAX_TOTAL + 1);
      const weight = (t) => 100 * (1 - (Math.log((t||0)+1) / logMax)); // 0..100

      // Sum main (and optional side) copies
      let copiesMain = 0, raw = 0;
      for (const m of matchedMain){
        copiesMain += m.count;
        raw += m.count * weight(m.total);
      }
      let copiesSide = 0, rawSide = 0;
      if (includeSide){
        for (const s of matchedSide){ copiesSide += s.count; rawSide += s.count * weight(s.total); }
      }

      // ----- Badges & density tiers -----
      const distinctUltra = new Set(matchedMain.filter(x => x.total <= THRESH_ULTRA).map(x => x.official)).size;
      const distinctDeep  = new Set(matchedMain.filter(x => x.total <= THRESH_DEEP ).map(x => x.official)).size;
      const distinctMed   = new Set(matchedMain.filter(x => x.total <= THRESH_MED  ).map(x => x.official)).size;
      const distinctLight = new Set(matchedMain.filter(x => x.total <= THRESH_LIGHT).map(x => x.official)).size;

      const deepCopies = matchedMain.filter(x => x.total <= THRESH_LIGHT)
                                    .reduce((a,b)=> a + b.count, 0);
      const deepDensity = copiesMain ? Math.round(100 * deepCopies / copiesMain) : 0;

      // ----- Base score (continuous) -----
      const rawMax = 60 * 100;                    // 60-card baseline
      const baseScore = Math.max(0, Math.min(100, ((raw + (includeSide ? rawSide : 0)) / rawMax) * 100));

      // ----- Density bonus (curved, max +25) -----
      const bonus = Math.round(25 * Math.pow(deepDensity / 100, 1.1));
      const finalScore = Math.max(0, Math.min(100, baseScore + bonus));

      // Top 5 jankiest by single-copy weight
      const allForTop = [...matchedMain].map(x => ({name:x.official, w: weight(x.total), total:x.total, count:x.count}));
      allForTop.sort((a,b)=> b.w - a.w);
      const top5 = allForTop.slice(0,5);

      return {
        score: Math.round(finalScore),
        baseScore: Math.round(baseScore),
        bonus,
        raw: Math.round(raw),
        copiesMain, copiesSide,
        distinctUltra, distinctDeep, distinctMed, distinctLight, deepDensity,
        top5,
        unmatched,
        matchedMain, matchedSide
      };
    }

    function renderDeckScore(r){
      const scoreEl = document.getElementById('scoreValue');
      const bar = document.getElementById('scoreBar');
      const flavor = document.getElementById('scoreFlavor');
      const badges = document.getElementById('badges');
      const top = document.getElementById('topJank');
      const notes = document.getElementById('notes');

      scoreEl.textContent = r.score;
      bar.style.width = r.score + '%';

      let msg = '';
      if (r.score >= 90) msg = '🌋 The Jank is STRONG with this one.';
      else if (r.score >= 70) msg = '🧪 Maximum spice achieved — expect the unexpected.';
      else if (r.score >= 50) msg = '🌶️ Solidly spicy — a connoisseur’s brew.';
      else if (r.score >= 30) msg = '🧯 Respectable heat with room to get weird.';
      else msg = '🛡️ More staple than spice. Dare to jank harder?';
      if (r.bonus >= 15) msg += ' 🧪 Dense spice pocket detected.';
      flavor.textContent = msg;

      badges.innerHTML = `
        <div class="small">🧿 <b>Ultra‑jank</b> (≤${THRESH_ULTRA} Total): <b>${r.distinctUltra}</b></div>
        <div class="small">💀 <b>Deep‑jank</b> (≤${THRESH_DEEP} Total): <b>${r.distinctDeep}</b></div>
        <div class="small">🧪 <b>Medium‑jank</b> (≤${THRESH_MED} Total): <b>${r.distinctMed}</b></div>
        <div class="small">🔥 <b>Light‑jank</b> (≤${THRESH_LIGHT} Total): <b>${r.distinctLight}</b></div>
        <div class="small">📈 Jank Density: <b>${r.deepDensity}%</b> of maindeck</div>
        <div class="small">➕ Density bonus added: <b>+${r.bonus}</b> (max +25)</div>
        <div class="small">🧮 Base score (pre‑bonus): <b>${r.baseScore}</b></div>
        <div class="small">🧾 Counted copies (main${r.copiesSide?'+side':''}): <b>${r.copiesMain}${r.copiesSide?` + ${r.copiesSide}`:''}</b></div>
      `;

      top.innerHTML = '';
      for (const t of r.top5){
        const li = document.createElement('li');
        // Simplified: name only (no total/weight suffix)
        li.textContent = t.name;
        top.appendChild(li);
      }

      notes.innerHTML = '';
      if (r.unmatched.length){
        for (const n of r.unmatched){ const li = document.createElement('li'); li.textContent = `Unmatched: ${n}`; notes.appendChild(li); }
      } else {
        const li = document.createElement('li'); li.textContent = 'All cards matched the dataset.'; notes.appendChild(li);
      }
    }
  </script>
</body>
</html>
