<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4HM Jank-O-Meter + Deck Validator (Staging)</title>
  <meta name="robots" content="noindex,nofollow"/>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>

  <style>
    body { font-family: "Book Antiqua", Palatino, serif; background:#fdf6e3; color:#2b1a08; margin:0; }
    header { background:#f9f2dd; border-bottom:2px solid #d6b87a; text-align:center; padding:20px; }
    main { max-width:1000px; margin:0 auto; padding:20px; }
    textarea { width:100%; min-height:180px; border:1px solid #ccc; padding:8px; border-radius:6px; }
    button { padding:8px 14px; border:none; background:#d6b87a; border-radius:6px; font-weight:bold; cursor:pointer; }
    button:hover { background:#c0a85f; }
    .valid { color:green; font-weight:700; }
    .invalid { color:red; font-weight:700; }
    .errlist { margin-left:20px; }
    .tag { display:inline-block; padding:2px 6px; margin-left:4px; background:#eee; border-radius:4px; font-size:0.8em; }
    .slider-container { margin:20px 0; text-align:center; }
    .quick-links { margin:10px 0; }
    #jankTable_wrapper { margin-top:20px; }
    .note { font-size:0.85em; color:#444; margin-top:10px; }
  </style>
</head>
<body>
  <header>
    <h1>⚡ 4HM Jank-O-Meter + Deck Validator — STAGING ⚠️</h1>
  </header>
  <main>
    <section>
      <h2>Deck Analyzer</h2>
      <textarea id="deckInput" placeholder="Paste your deck list here..."></textarea>
      <br>
      <button id="analyzeValidateBtn">Analyze & Validate Deck</button>
      <label style="margin-left:8px;"><input type="checkbox" id="includeSb" checked> Include sideboard in score</label>
      <div id="score">Score: --</div>
      <div id="valStatus">—</div>
      <ul id="valErrors" class="errlist"></ul>
      <div id="topJank"></div>
    </section>

    <section class="slider-container">
      <h2>Jank-O-Meter</h2>
      <label for="jankSlider">Jank Threshold: <span id="jankValue"></span></label><br>
      <input type="range" id="jankSlider" min="1" max="20" value="4">
      <div class="quick-links">
        Quick Links: 
        <a href="#" class="quick" data-v="1">≤1</a> |
        <a href="#" class="quick" data-v="2">≤2</a> |
        <a href="#" class="quick" data-v="4">≤4</a> |
        <a href="#" class="quick" data-v="10">≤10</a> |
        <a href="#" class="quick" data-v="20">≤20</a>
      </div>
      <div id="topInfo"></div>
      <table id="jankTable" class="display" style="width:100%"></table>
      <div class="note">Special limits: <b>leg6orMore</b> — max <b>2 unique</b> cards from this group across the deck.</div>
    </section>
  </main>

  <script>
    const CARDPOOL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbTvT5tNT1w_Nqz1dL-t3muSuqzQ8UkO9ssHNZT1koEM8iVQQuY7QwGpTImtqv58zT837gLm8GZG84/pub?output=csv";

    let LEGAL_CARDS = new Map();
    let BANNED = new Set();
    let RESTRICTED = new Set();
    let LEG6PLUS = new Set();
    const BASIC_SET = new Set(["plains","island","swamp","mountain","forest"]);

    let MAX_TOTAL = 0;
    let allRows = [];
    let dataTable;

    function normName(n){ return n.toLowerCase().replace(/[^a-z0-9]/g,""); }

    function parseCSV(url){
      return new Promise((resolve,reject)=>{
        Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:res=>resolve(res.data),error:reject});
      });
    }

    async function boot(){
      const pool = await parseCSV(CARDPOOL_URL);
      ingestPool(pool);
      initUI();
      document.getElementById('analyzeValidateBtn').addEventListener('click', ()=>{
        const deckText = document.getElementById('deckInput').value;
        const parsed = parseDeck(deckText);
        const val = validateDeck(parsed);
        renderValidation(val);
        const score = calcJankScore(parsed);
        renderScore(score);
        renderTopJank(parsed);
      });
    }

    function ingestPool(rows){
      for(const r of rows){
        const nm = normName(r.name||"");
        if(!nm) continue;
        LEGAL_CARDS.set(nm, r);
        if(String(r.banned).toLowerCase()==="true") BANNED.add(nm);
        if(String(r.restricted).toLowerCase()==="true") RESTRICTED.add(nm);
        if(String(r.leg6orMore).toLowerCase()==="true") LEG6PLUS.add(nm);
        const t = Number(r["4hmTotal"]||r.total||0);
        if(t>MAX_TOTAL) MAX_TOTAL = t;
        allRows.push({set:r.set||"", card:r.name, main:Number(r["4hmMainDeck"]||0), side:Number(r["4hmSideBoard"]||0), total:t});
      }
    }

    function parseDeck(text){
      const lines=text.split(/\r?\n/);
      const main=new Map(); const side=new Map();
      let toSide=false;
      for(const raw of lines){
        const line=raw.trim(); if(!line) continue;
        if(/^side/i.test(line)){ toSide=true; continue; }
        const m=line.match(/^(\d+)?\s*(.+)$/);
        if(!m) continue;
        const count=parseInt(m[1]||"1");
        const nm=normName(m[2]);
        const bucket=toSide?side:main;
        bucket.set(nm,(bucket.get(nm)||0)+count);
      }
      return {main,side};
    }

    function validateDeck(parsed){
      const totals=new Map();
      let mainCount=0, sideCount=0;
      for(const [n,c] of parsed.main){ totals.set(n,(totals.get(n)||0)+c); mainCount+=c; }
      for(const [n,c] of parsed.side){ totals.set(n,(totals.get(n)||0)+c); sideCount+=c; }
      const errors=[];
      if(mainCount<60) errors.push(`Main deck has ${mainCount} cards (<60).`);
      if(sideCount>15) errors.push(`Sideboard has ${sideCount} cards (>15).`);

      let leg6Unique=new Set();
      for(const [nm,count] of totals){
        if(BASIC_SET.has(nm)) continue;
        if(!LEGAL_CARDS.has(nm)) { errors.push(`Not in card pool: ${nm}`); continue; }
        if(BANNED.has(nm)) errors.push(`BANNED: ${LEGAL_CARDS.get(nm).name}`);
        if(RESTRICTED.has(nm) && count>1) errors.push(`Restricted (max1): ${LEGAL_CARDS.get(nm).name} has ${count}`);
        if(!RESTRICTED.has(nm) && count>4) errors.push(`Too many copies (>4): ${LEGAL_CARDS.get(nm).name} has ${count}`);
        if(LEG6PLUS.has(nm) && count>0) leg6Unique.add(nm);
      }
      if(leg6Unique.size>2) errors.push(`6+ mana Legendary group exceeded: ${leg6Unique.size} unique (max2).`);

      return {ok:errors.length===0, errors};
    }

    function calcJankScore(parsed){
      const includeSb=document.getElementById('includeSb').checked;
      let totals=new Map();
      for(const [n,c] of parsed.main) totals.set(n,(totals.get(n)||0)+c);
      if(includeSb) for(const [n,c] of parsed.side) totals.set(n,(totals.get(n)||0)+c);
      let sum=0, count=0;
      for(const [nm,c] of totals){
        const row=LEGAL_CARDS.get(nm); if(!row) continue;
        const t=Number(row["4hmTotal"]||row.total||0);
        const weight=100*(1 - Math.log((t||0)+1)/Math.log(MAX_TOTAL+1));
        sum+=weight; count++;
      }
      return count?Math.round(sum/count):0;
    }

    function renderScore(score){
      document.getElementById('score').innerHTML=`Jank Score: ${score} / 100`;
    }

    function renderValidation(res){
      const status=document.getElementById('valStatus');
      const list=document.getElementById('valErrors');
      list.innerHTML="";
      if(res.ok) status.innerHTML='<span class="valid">✅ Deck is legal.</span>';
      else status.innerHTML='<span class="invalid">⛔ Deck is NOT legal</span>';
      for(const e of res.errors){
        const li=document.createElement('li'); li.textContent=e; list.appendChild(li);
      }
    }

    function renderTopJank(parsed){
      const includeSb=document.getElementById('includeSb').checked;
      let totals=new Map();
      for(const [n,c] of parsed.main) totals.set(n,(totals.get(n)||0)+c);
      if(includeSb) for(const [n,c] of parsed.side) totals.set(n,(totals.get(n)||0)+c);
      const arr=[];
      for(const [nm,c] of totals){
        const row=LEGAL_CARDS.get(nm); if(!row) continue;
        const t=Number(row["4hmTotal"]||row.total||0);
        const weight=100*(1 - Math.log((t||0)+1)/Math.log(MAX_TOTAL+1));
        arr.push({name:row.name,total:t,w:weight});
      }
      arr.sort((a,b)=>b.w-a.w);
      const top=arr.slice(0,10);
      const tier = (t)=> t<=1? 'Ultra‑Jank' : t<=4? 'Deep Jank' : t<=10? 'Medium Jank' : t<=20? 'Light Jank' : '';
      const div=document.getElementById('topJank');
      div.innerHTML='<b>Top 10 Jankiest in Deck</b><ul>'+top.map(t=>`<li>${t.name} ${tier(t.total)?`<span class="tag">${tier(t.total)}</span>`:""}</li>`).join('')+'</ul>';
    }

    function initUI(){
      const slider=document.getElementById('jankSlider');
      const val=document.getElementById('jankValue');
      val.textContent=slider.value;
      slider.addEventListener('input',()=>{ val.textContent=slider.value; renderTable(Number(slider.value)); });
      document.querySelectorAll('.quick').forEach(a=>{
        a.addEventListener('click',e=>{ e.preventDefault(); const v=Number(a.dataset.v); slider.value=v; val.textContent=v; renderTable(v); });
      });
      renderTable(Number(slider.value));
    }

    function renderTable(threshold){
      const data=allRows.filter(r=>r.total<=threshold).map(r=>[r.set,r.card,r.main,r.side,r.total]);
      if(dataTable){ dataTable.clear().rows.add(data).order([[4,'desc'],[0,'asc'],[1,'asc']]).draw(); return; }
      dataTable=jQuery('#jankTable').DataTable({
        data,
        columns:[{title:'Set'},{title:'Card'},{title:'Main Deck'},{title:'Sideboard'},{title:'Total'}],
        order:[[4,'desc'],[0,'asc'],[1,'asc']],
        pageLength:25,
        deferRender:true,
        dom:'tip'
      });
      const topInfo=document.getElementById('topInfo');
      if(topInfo){
        dataTable.on('draw',()=>{
          const info=dataTable.page.info();
          topInfo.textContent=`Showing ${info.start+1} to ${info.end} of ${info.recordsDisplay} entries`;
        });
        dataTable.draw();
      }
    }

    window.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
