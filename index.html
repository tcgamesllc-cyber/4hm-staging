<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>4HM Jank‑O‑Meter + Deck Validator (Staging v‑next)</title>
  <meta name="robots" content="noindex,nofollow"/>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <style>
    :root { --bg:#fdf6e3; --card:#f9f2dd; --ink:#2b1a08; --muted:#7c6a4c; --accent:#8b4513; --bad:#8b1a1a; --link:#174ea6; }
    html, body { margin:0; padding:0; min-height:100%; box-sizing:border-box; background: var(--bg); color:var(--ink); font:16px/1.5 "Book Antiqua", Palatino, serif; }

    body { background-image: radial-gradient(1200px 700px at 20% 10%, #fff9e6, rgba(0,0,0,0) 70%), radial-gradient(1000px 600px at 80% 20%, #f8edd4, rgba(0,0,0,0) 70%), radial-gradient(1400px 800px at 50% 90%, #f3e4c1, rgba(0,0,0,0) 70%), linear-gradient(#fdf6e3, #fdf6e3); border:24px solid transparent; border-image-source:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3e%3crect width='80' height='80' fill='%23d6b87a'/%3e%3cg opacity='0.25'%3e%3cpath d='M0 0h80v80H0z' fill='none' stroke='%23b89654' stroke-width='2'/%3e%3c/g%3e%3c/svg%3e"); border-image-slice:100; border-image-repeat:round; }

    header { background: radial-gradient(circle at top left, #fff9e6, #fdf6e3 60%, #f3e4c1); border-bottom:4px solid #d6b87a; border-top:4px solid #d6b87a; box-shadow:0 4px 12px rgba(0,0,0,0.35); padding:20px 12px; text-align:center; position:relative; z-index:1; }
    header h1 { margin:0; font-size:30px; color:#3a240a; text-shadow:1px 1px 0 #fff; }
    header .sub { margin-top:6px; font-size:14px; color:#5a3816; }

    .wrap { max-width:1100px; margin:16px auto 60px; padding:0 12px; position:relative; z-index:1; }
    .panel { background:var(--card); border-radius:16px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,.25); margin-bottom:14px; }

    /* FILTER AREA */
    .controls { display:grid; gap:10px; grid-template-columns:1fr; align-items:center; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .pill { background:#f2e6c6; border:1px solid #c8a96c; color:var(--ink); padding:8px 10px; border-radius:12px; display:flex; align-items:center; gap:10px; flex:1 1 auto; min-width:0; white-space:normal; }
    .pill label { display:inline-flex; align-items:center; gap:6px; margin-right:10px; }
    .muted { color:var(--muted); font-size:13px; }
    .kpi { font-weight:700; color:var(--accent); }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { background:#fdf6e3; border:1px solid #c8a96c; color:#3a240a; padding:8px 12px; border-radius:10px; cursor:pointer; font-family:"Book Antiqua", Palatino, serif; }
    .btn:hover { background:#f8edd4; }
    .btn-mini { padding: 4px 8px; font-size: 13px; border-radius: 8px; }
    .btn-ghost { background:transparent; }

    input[type="range"] { -webkit-appearance:none !important; appearance:none !important; width:100%; height:10px; border-radius:5px; background:linear-gradient(to right, #d6b87a, #b38b4d); outline:none; cursor:pointer; border:1px solid #8b5a2b; box-shadow:inset 0 0 4px rgba(0,0,0,.4); }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none !important; appearance:none !important; width:20px; height:20px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #d6b87a, #8b5a2b); border:2px solid #5c3b16; box-shadow:inset 0 0 6px #d6b87a, 0 0 2px #000; cursor:pointer; transition:transform .05s ease-in-out; }

    #thresholdNumber { width:80px; background:#fff9e6; color:#2b1a08; border:2px solid #c8a96c; border-radius:8px; padding:6px 8px; font-family:'Book Antiqua', Palatino, serif; box-shadow:inset 0 0 5px #d6b87a; }

    .search-input { width:220px; background:#fff9e6; color:#2b1a08; border:1px solid #c8a96c; border-radius:8px; padding:6px 8px; }
    .num-input { width:90px; background:#fff9e6; color:#2b1a08; border:1px solid #c8a96c; border-radius:8px; padding:6px 8px; }

    /* Mobile filter drawer */
    .drawer-toggle { display:none; justify-content:space-between; align-items:center; gap:8px; }
    .drawer-toggle .count { font-size:12px; color:#5a3816; }

    #moreFilters { display:block; }

    /* TABLE */
    .table-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; }
    table.dataTable { width:100%; background:#fdf6e3; border:2px solid #d6b87a; border-radius:12px; overflow:hidden; }
    table.dataTable thead th { background:#f2e6c6; color:#3a240a; font-weight:bold; border-bottom:2px solid #d6b87a; }
    table.dataTable tbody tr:nth-child(even) { background:#fbf2de; }
    table.dataTable tbody tr:nth-child(odd)  { background:#f6ebd2; }
    table.dataTable tbody td { color:#2b1a08; }

    .tag { display:inline-block; padding:2px 6px; border-radius:999px; border:1px solid #c8a96c; background:#fff9e6; margin-left:6px; font-size:12px; color:#5a3816; }
    .tag.banned { border-color:#b66; background:#fde9e9; color:var(--bad); }
    .tag.restricted { border-color:#b88; background:#fbeff8; }

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); padding: 16px; z-index: 1000; }
    .modal.open { display: flex; }
    .modal-card { max-width:680px; width:100%; background:var(--card); border:2px solid #c8a96c; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding: 14px; }
    .modal-head { display:flex; align-items:flex-start; gap:8px; }
    .modal-title { font-weight:800; color:#3a240a; font-size:20px; }
    .modal-close { margin-left:auto; cursor:pointer; border:1px solid #c8a96c; background:#fff9e6; border-radius:10px; padding:4px 8px; }
    pre.cardtext { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; background:#fff9e6; border: 1px solid #c8a96c; border-radius: 8px; padding:8px; }
    .card-top { display:flex; align-items:flex-start; gap:12px; }
    .mc-right { margin-left:auto; text-align:right; }
    .type-line { margin:6px 0 8px 0; font-style:italic; }
    .card-footer { display:flex; align-items:center; justify-content:space-between; margin-top:8px; }
    .artist { font-size:12px; color:#6b5a3a; }
    .pt { font-weight:700; border:1px solid #c8a96c; padding:2px 6px; border-radius:8px; background:#fff9e6; }
    a.cardlink { color:var(--link); text-decoration:underline; cursor:pointer; }

    /* RESPONSIVE */
    @media (max-width: 900px){
      .controls { gap:8px; }
      .pill { font-size:15px; }
      .search-input { width:100%; }
      .drawer-toggle { display:flex; }
      #moreFilters { display:none; }
      #moreFilters.open { display:block; }
      .pill { width:100%; }
      .row { flex-direction:column; gap:8px; }
      input[type="range"]{ width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>⚡ 4HM Jank‑O‑Meter ⚡</h1>
    <div class="sub">Filter rarely‑played cards, score your deck’s Jank, and validate 4HM legality with the current rules.</div>
  </header>

  <div class="wrap">
    <div class="panel">
      <!-- Mobile filter drawer button -->
      <div class="drawer-toggle">
        <button id="toggleFilters" class="btn btn-ghost">☰ Filters</button>
        <div class="count" id="activeFilters">0 active</div>
      </div>

      <div class="controls">
        <!-- Always-visible basic row -->
        <div class="row">
          <div class="pill" title="Set the maximum total appearances to include">
            <span>Threshold ≤ <span id="thresholdLabel" class="kpi">…</span></span>
            <input id="threshold" type="range" min="0" max="100" value="5" step="1"/>
            <input id="thresholdNumber" type="number" min="0" value="5" step="1" title="Type an exact threshold"/>
          </div>
          <div class="pill" id="quickPresets" title="Quick jank thresholds">
            Quick:
            <button class="btn btn-mini" data-th="1">≤1</button>
            <button class="btn btn-mini" data-th="2">≤2</button>
            <button class="btn btn-mini" data-th="4">≤4</button>
            <button class="btn btn-mini" data-th="10">≤10</button>
            <button class="btn btn-mini" data-th="20">≤20</button>
          </div>
          <div class="pill" title="Filter by set">
            <label for="setFilter" class="muted">Set:</label>
            <select id="setFilter" style="background:#fff9e6; color:#2b1a08; border:1px solid #c8a96c; border-radius:8px; padding:6px 8px;">
              <option value="">All Sets</option>
            </select>
          </div>
          <div class="pill" title="Search card name">
            <label class="muted">Search:</label>
            <input id="nameSearch" class="search-input" type="text" placeholder="Card name…"/>
          </div>
        </div>

        <!-- Drawer content: advanced filters -->
        <div id="moreFilters">
          <div class="row">
            <div class="pill" title="Filter by color in casting cost (select any combination)">
              <span class="muted">Colors:</span>
              <label><input type="checkbox" class="cf" data-c="W"> W</label>
              <label><input type="checkbox" class="cf" data-c="U"> U</label>
              <label><input type="checkbox" class="cf" data-c="B"> B</label>
              <label><input type="checkbox" class="cf" data-c="R"> R</label>
              <label><input type="checkbox" class="cf" data-c="G"> G</label>
              <label><input type="checkbox" class="cf" data-c="C"> C</label>
              <span class="muted" style="margin-left:8px">•</span>
              <label title="Require cards to contain ALL selected colors (instead of ANY)."><input type="checkbox" id="colorModeAll"> Match ALL</label>
            </div>
            <div class="pill" title="Filter by card types (any combination)">
              <span class="muted">Types:</span>
              <label><input type="checkbox" class="tf" data-t="creature"> Creature</label>
              <label><input type="checkbox" class="tf" data-t="artifact"> Artifact</label>
              <label><input type="checkbox" class="tf" data-t="artifact creature"> Artifact Creature</label>
              <label><input type="checkbox" class="tf" data-t="enchantment"> Enchantment</label>
              <label><input type="checkbox" class="tf" data-t="instant"> Instant</label>
              <label><input type="checkbox" class="tf" data-t="sorcery"> Sorcery</label>
              <label><input type="checkbox" class="tf" data-t="land"> Land</label>
            </div>
          </div>
          <div class="row">
            <div class="pill" title="Filter by supertypes (any combination)">
              <span class="muted">Supertypes:</span>
              <label><input type="checkbox" class="sf" data-s="legendary"> Legendary</label>
              <label><input type="checkbox" class="sf" data-s="world"> World</label>
              <label><input type="checkbox" class="sf" data-s="basic"> Basic</label>
            </div>
            <div class="pill" title="Filter by rarity">
              <span class="muted">Rarity:</span>
              <span id="rarityFilters"></span>
            </div>
          </div>
          <div class="row">
            <div class="pill" title="Filter by mana value (converted mana cost)">
              <span class="muted">Mana Value:</span>
              <label>Min <input id="mvMin" class="num-input" type="number" min="0" step="1" placeholder="0"/></label>
              <label>Max <input id="mvMax" class="num-input" type="number" min="0" step="1" placeholder=""/></label>
            </div>
            <div class="pill actions" title="Actions">
              <button id="resetFilters" class="btn" title="Reset all filters to defaults">Reset</button>
              <button id="exportBtn" class="btn" title="Download CSV view">Export CSV</button>
              <button id="copyLinkBtn" class="btn" title="Copy a sharable link with your current settings">Copy Link</button>
            </div>
          </div>
        </div>

        <div class="muted" id="meta">Loading data…</div>
        <div class="muted" id="topInfo" aria-live="polite"></div>
        <div id="err" style="display:none"></div>
      </div>
    </div>

    <div class="panel">
      <div class="table-wrap">
        <table id="jankTable" class="display">
          <thead>
            <tr><th>Set</th><th>Card</th><th>Main Deck</th><th>Sideboard</th><th>Total</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" id="lastUpdated">⏱️ <b>Last updated:</b> …</div>
    </div>

    <div class="panel" id="scorePanel">
      <h2 style="margin:0 0 10px 0; color:#3a240a;">🧪 Jank Score & ✅ Deck Validator</h2>
      <div class="grid" style="display:grid; grid-template-columns:1fr; gap:12px;">
        <div>
          <label for="deckInput" class="muted">Paste your Tolaria/ManaStack/Moxfield‑style list here (sideboard optional):</label>
          <textarea id="deckInput" style="width:100%; min-height:180px; box-sizing:border-box; background:#fff9e6; border:2px solid #c8a96c; border-radius:12px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;"></textarea>
          <div class="muted" style="margin-top:6px; font-size:13px;">
            <input type="file" id="deckFile" accept=".txt,.dek,.dec"/>
            <button id="analyzeBtn" class="btn">Analyze &amp; Validate Deck</button>
            <label style="margin-left:8px;"><input type="checkbox" id="includeSb"/> Include sideboard in score</label>
          </div>
        </div>
        <div class="row" style="align-items:stretch;">
          <div class="pill" style="min-width:260px; flex:1 1 260px;">
            <div><b>Jank Score</b> <span id="scoreValue" class="kpi">—</span>/100</div>
            <div style="height:12px; background:#eadfbe; border:1px solid #c8a96c; border-radius:999px; overflow:hidden; width:100%;"><div id="scoreBar" style="height:100%; background:linear-gradient(90deg,#6bcb6b,#ffd166,#ff9248,#ef476f); width:0%"></div></div>
            <div id="scoreFlavor" class="muted">Paste a deck to score it.</div>
          </div>
          <div class="pill" style="min-width:260px; flex:1 1 260px;">
            <div><b>Badges</b></div>
            <div id="badges" class="muted">—</div>
          </div>
        </div>
        <div class="pill"><div><b>Top 10 Jankiest in Deck</b><ol id="topJank" style="margin:6px 0 0 16px;"></ol></div></div>
        <div class="pill"><div><b>Deck Validator Results</b><div id="valStatus" class="muted">—</div><ul id="valErrors"></ul><div id="valCounts" class="muted"></div><div class="muted">Special limits: <b>6+ CMC Legendary Creatures</b> — max <b>2 unique</b>. <b>5 CMC Legendary Creatures</b> — max <b>1 unique</b>. Legendary Creatures do <i>not</i> count toward the “4 rarely‑played” requirement.</div></div></div>
      </div>
    </div>
  </div>

  <div id="cardModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cardTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div class="card-top" style="width:100%">
          <div>
            <div id="cardTitle" class="modal-title">Card</div>
            <div class="type-line" id="typeLine">—</div>
          </div>
          <div class="mc-right"><div id="costSet">—</div></div>
        </div>
        <button class="modal-close" id="modalClose">Close</button>
      </div>
      <pre id="cardText" class="cardtext"></pre>
      <div class="card-footer">
        <div class="artist" id="artist">Artist — ?</div>
        <div class="pt" id="pt">—/—</div>
      </div>
      <div class="muted" id="banInfo" style="margin-top:6px;"></div>
    </div>
  </div>

  <script>
    const CARDPOOL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbTvT5tNT1w_Nqz1dL-t3muSuqzQ8UkO9ssHNZT1koEM8iVQQuY7QwGpTImtqv58zT837gLm8GZG84/pub?output=csv";
    const BR_URL       = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP2NPEcvsNl4wkBSKApw-opRIZ-C3rwFj51wJbMh1wYm_ci8y7o46gyfSubTbsfApvpoJpS2ysRohD/pub?output=csv";

    let allRows = []; let dataTable = null; let MAX_TOTAL = 0;
    let LEGAL_CARDS = new Map(); let NAME_MAP = new Map();
    let BANNED = new Set(); let RESTRICTED = new Set();
    const HARD_BANNED = new Set(["bloodmoon","karakas","arenaoftheancients","bronzetablet","cityinabottle","golgothiansylex","jeweledbird","libraryofalexandria","moat","rebirth","shahrazad","tempestefreet"]);

    const params = new URLSearchParams(location.search);
    const colorState = new Set(); let colorModeAll = false; const typeState = new Set(); const superState = new Set(); const rarityState = new Set();
    let mvMin = null, mvMax = null; let nameQuery = '';
    const ALL_RARITIES = new Set();

    function normName(s){ return String(s||'').normalize('NFKD').replace(/[\u2018\u2019\u201A\u201B\u2032]/g, "'").replace(/[\u201C\u201D\u201E\u201F\u2033]/g, '"').replace(/[\u2013\u2014]/g, '-').replace(/\[[^\]]*\]/g,'').replace(/\([^)]*\)$/,'').replace(/\s+/g,' ').trim().toLowerCase().replace(/[^a-z0-9]/g,''); }
    function parseCSV(url){ return new Promise((resolve,reject)=>{ Papa.parse(url,{download:true,header:true,skipEmptyLines:'greedy',complete:r=>resolve(r.data||[]),error:reject}); }); }
    function typeHas(t, word){ return new RegExp(`(?:^|,|\\s)${word}(?:,|\\s|$)`, 'i').test(t||''); }

    window.addEventListener('DOMContentLoaded', () => { bindDeckTools(); boot(); bindDrawer(); });

    async function boot(){ try{ const [pool, br] = await Promise.all([ parseCSV(CARDPOOL_URL), parseCSV(BR_URL) ]); ingestPool(pool); ingestBR(br); if(MAX_TOTAL<1) MAX_TOTAL=1; initUI(); stampDates(); } catch(e){ showErr('Data load issue — try refresh. '+(e?.message||e)); console.error(e);} }
    function stampDates(){ const now = new Date().toLocaleString(); document.getElementById('lastUpdated').innerHTML = `⏱️ <b>Last updated:</b> ${now}`; }
    function showErr(msg){ const el=document.getElementById('err'); el.style.display='block'; el.textContent = typeof msg==='string'? msg : (msg?.message||JSON.stringify(msg)); }

    function ingestPool(rows){ if(!rows?.length) return; const headers=Object.keys(rows[0]||{}); const nk=headers.find(h=>/^name$/i.test(h))||headers[0]; const sk=headers.find(h=>/^set$/i.test(h)); const mk=headers.find(h=>/4hm\s*main(deck)?/i.test(h))||'4hmMainDeck'; const sbk=headers.find(h=>/4hm\s*side(board)?/i.test(h))||'4hmSideBoard'; const tk=headers.find(h=>/4hm\s*total/i.test(h))||'4hmTotal'; const toNum=v=>{const n=Number(String(v||'').replace(/,/g,'')); return isFinite(n)?n:0;};
      for(const r of rows){ const raw=r[nk]; if(!raw) continue; const key=normName(raw); const set=String(sk? r[sk] : '').trim(); const main=toNum(r[mk]); const side=toNum(r[sbk]); const tot=toNum(r[tk]); const text=String(r.text||r.oracleText||r.rules||r["rules text"]||'').trim(); const manaCost=String(r.manaCost||r["mana cost"]||r.cost||'').trim(); const mv=Number(r.manaValue||r.cmc||0); const typesStr=String(r.types||'').toLowerCase(); const supersStr=String(r.supertypes||'').toLowerCase(); const subtypesStr=String(r.subtypes||'').toLowerCase(); const typesSet=new Set(typesStr.split(/[\s,;]+/).filter(Boolean)); const supersSet=new Set(supersStr.split(/[\s,;]+/).filter(Boolean)); const rarity=String(r.rarity||'').toLowerCase().trim(); if(rarity) ALL_RARITIES.add(rarity); const artist=String(r.artist||'').trim(); const power=(r.power!=null? String(r.power).trim(): ''); const toughness=(r.toughness!=null? String(r.toughness).trim(): '');
        NAME_MAP.set(key,String(raw)); LEGAL_CARDS.set(key,r);
        if(String(r.banned).toLowerCase()==='true') BANNED.add(key); if(String(r.restricted).toLowerCase()==='true') RESTRICTED.add(key);
        if(tot>MAX_TOTAL) MAX_TOTAL=tot;
        allRows.push({ set, card:String(raw), main, side, total:tot, text, manaCost, mv, key, typesStr, supersStr, subtypesStr, typesSet, supersSet, rarity, artist, power, toughness }); }
    }
    function ingestBR(rows){ if(!rows?.length) return; const headers=Object.keys(rows[0]||{}); const nk=headers.find(h=>/^name$/i.test(h)||/card\s*name/i.test(h)||/^card$/i.test(h))||headers[0]; const bk=headers.find(h=>/^banned$/i.test(h)); const rk=headers.find(h=>/^restricted$/i.test(h)); const truthy=v=>{const s=String(v||'').trim().toLowerCase(); return s && s!=='0' && s!=='false' && s!=='no' && s!=='n' && s!=='na';}; for(const r of rows){ const key=normName(r[nk]); if(!key) continue; if(bk && truthy(r[bk])) BANNED.add(key); if(rk && truthy(r[rk])) RESTRICTED.add(key); } }

    function initUI(){
      const slider=document.getElementById('threshold'); const box=document.getElementById('thresholdNumber'); const label=document.getElementById('thresholdLabel'); const q=params.get('max'); const initialAbs=Math.min(q?Number(q):4, Math.max(1,MAX_TOTAL));
      const toAbs=s=>{const k=Math.log(Math.max(1,MAX_TOTAL)+1)/100; return Math.round(Math.exp(k*s)-1);} ;
      const toSlider=t=>{const k=Math.log(Math.max(1,MAX_TOTAL)+1)/100; return Math.round(Math.log((t||0)+1)/(k||1));};
      slider.min='0'; slider.max='100'; slider.value=String(toSlider(initialAbs)); box.min='0'; box.max=String(Math.max(1,MAX_TOTAL)); box.value=String(initialAbs); label.textContent=Number(initialAbs).toLocaleString();
      const syncFromSlider=sVal=>{const abs=toAbs(Number(sVal)); box.value=String(abs); label.textContent=abs.toLocaleString(); renderTable(abs, document.getElementById('setFilter').value||""); updateQuery(abs); updateActiveFilters();};
      const syncFromBox=bVal=>{const abs=Math.max(0, Math.min(Number(bVal)||0, Math.max(1,MAX_TOTAL))); slider.value=String(toSlider(abs)); label.textContent=abs.toLocaleString(); renderTable(abs, document.getElementById('setFilter').value||""); updateQuery(abs); updateActiveFilters();};
      slider.addEventListener('input', e=>syncFromSlider(e.target.value)); box.addEventListener('input', e=>syncFromBox(e.target.value));
      document.querySelectorAll('#quickPresets .btn-mini').forEach(b=>b.addEventListener('click',()=>{const abs=Math.min(Number(b.dataset.th), Math.max(1,MAX_TOTAL)); box.value=String(abs); slider.value=String(toSlider(abs)); label.textContent=abs.toLocaleString(); renderTable(abs, document.getElementById('setFilter').value||""); updateQuery(abs); updateActiveFilters(); }));

      populateSetFilter(allRows.map(r=>r.set)); populateRarityFilters();

      document.querySelectorAll('.cf').forEach(cb=>cb.addEventListener('change',()=>{ const c=cb.dataset.c; cb.checked? colorState.add(c): colorState.delete(c); redraw(); updateActiveFilters(); }));
      document.getElementById('colorModeAll').addEventListener('change', e=>{ colorModeAll=!!e.target.checked; redraw(); });
      document.querySelectorAll('.tf').forEach(cb=>cb.addEventListener('change',()=>{ const t=cb.dataset.t; cb.checked? typeState.add(t): typeState.delete(t); redraw(); updateActiveFilters(); }));
      document.querySelectorAll('.sf').forEach(cb=>cb.addEventListener('change',()=>{ const s=cb.dataset.s; cb.checked? superState.add(s): superState.delete(s); redraw(); updateActiveFilters(); }));

      document.getElementById('nameSearch').addEventListener('input', e=>{ nameQuery=String(e.target.value||'').trim().toLowerCase(); redraw(); });
      document.getElementById('mvMin').addEventListener('input', e=>{ const v=e.target.value; mvMin=v===''? null : Number(v); redraw(); updateActiveFilters(); });
      document.getElementById('mvMax').addEventListener('input', e=>{ const v=e.target.value; mvMax=v===''? null : Number(v); redraw(); updateActiveFilters(); });

      document.getElementById('resetFilters').addEventListener('click', ()=>{ document.querySelectorAll('.cf,.tf,.sf,.rf').forEach(cb=>cb.checked=false); colorState.clear(); typeState.clear(); superState.clear(); rarityState.clear(); document.getElementById('nameSearch').value=''; nameQuery=''; document.getElementById('mvMin').value=''; document.getElementById('mvMax').value=''; mvMin=null; mvMax=null; document.getElementById('colorModeAll').checked=false; colorModeAll=false; document.getElementById('setFilter').value=''; const abs=Number(document.getElementById('thresholdNumber').value)||0; renderTable(abs,''); updateActiveFilters(); });

      renderTable(initialAbs, params.get('set')); updateActiveFilters();
      document.getElementById('exportBtn').addEventListener('click', exportCSV); document.getElementById('copyLinkBtn').addEventListener('click', copySharableLink);
    }

    function bindDrawer(){ const btn=document.getElementById('toggleFilters'); const drawer=document.getElementById('moreFilters'); btn?.addEventListener('click', ()=>{ drawer.classList.toggle('open'); }); }

    function updateActiveFilters(){ const n = colorState.size + typeState.size + superState.size + rarityState.size + (mvMin!=null?1:0) + (mvMax!=null?1:0) + (document.getElementById('setFilter').value?1:0) + (document.getElementById('nameSearch').value?1:0); const el=document.getElementById('activeFilters'); if(el) el.textContent = `${n} active`; }

    function redraw(){ const abs=Number(document.getElementById('thresholdNumber').value)||0; renderTable(abs, document.getElementById('setFilter').value||''); }

    function populateSetFilter(sets){ const sel=document.getElementById('setFilter'); const uniq=Array.from(new Set(sets)).sort((a,b)=>a.localeCompare(b)); uniq.forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; sel.appendChild(opt); }); const qSet=params.get('set'); if(qSet) sel.value=qSet; sel.addEventListener('change', ()=>{ redraw(); updateQuery(Number(document.getElementById('thresholdNumber').value)); updateActiveFilters(); }); }

    function populateRarityFilters(){ const host=document.getElementById('rarityFilters'); const rars=Array.from(ALL_RARITIES).sort(); host.innerHTML = rars.map(r=>`<label><input type="checkbox" class="rf" data-r="${r}"> ${r.charAt(0).toUpperCase()+r.slice(1)}</label>`).join(' '); host.querySelectorAll('.rf').forEach(cb=> cb.addEventListener('change', ()=>{ const r=cb.dataset.r; cb.checked? rarityState.add(r): rarityState.delete(r); redraw(); updateActiveFilters(); })); }

    function passesColorFilter(row){ if(!colorState.size) return true; const wantsC=colorState.has('C'); const sel=new Set([...colorState].filter(c=>'WUBRG'.includes(c))); const hasColors=row.colors && row.colors.size>0; if(wantsC && sel.size===0) return !hasColors; if(colorModeAll){ for(const c of sel){ if(!row.colors.has(c)) return false; } return true; } else { if(wantsC && !hasColors) return true; for(const c of sel){ if(row.colors.has(c)) return true; } return false; } }
    function passesTypeFilter(row){ if(!typeState.size) return true; let pass=false; for(const t of typeState){ if(t==='artifact creature'){ if(row.typesSet && row.typesSet.has('artifact') && row.typesSet.has('creature')) { pass=true; break; } } else if(row.typesSet && row.typesSet.has(t)){ pass=true; break; } } return pass; }
    function passesSuperFilter(row){ if(!superState.size) return true; for(const s of superState){ if(row.supersSet && row.supersSet.has(s)) return true; } return false; }
    function passesRarityFilter(row){ if(!rarityState.size) return true; return rarityState.has(row.rarity); }
    function passesManaFilter(row){ if(mvMin!=null && !(row.mv>=mvMin)) return false; if(mvMax!=null && !(row.mv<=mvMax)) return false; return true; }
    function passesNameSearch(row){ if(!nameQuery) return true; return row.card.toLowerCase().includes(nameQuery); }

    function renderTable(threshold, setFilter){ const rows=allRows.filter(r=> r.total<=threshold && (!setFilter || r.set===setFilter) && passesColorFilter(r) && passesTypeFilter(r) && passesSuperFilter(r) && passesRarityFilter(r) && passesManaFilter(r) && passesNameSearch(r)); const data = rows.map(r=>{ const isBan=BANNED.has(r.key) || HARD_BANNED.has(r.key); const isRes=RESTRICTED.has(r.key); const tags = `${isBan?'<span class="tag banned">BANNED</span>':''}${(!isBan && isRes)?'<span class="tag restricted">Restricted</span>':''}`; const link=`<a href="#" class="cardlink" data-key="${r.key}">${r.card}</a>${tags}`; return [r.set, link, r.main, r.side, r.total]; }); if(dataTable){ dataTable.clear().rows.add(data).order([[4,'desc'],[0,'asc'],[1,'asc']]).draw(); bindRowClicks(); } else { dataTable = jQuery('#jankTable').DataTable({ data, columns: [ { title: 'Set' }, { title: 'Card' }, { title: 'Main Deck' }, { title: 'Sideboard' }, { title: 'Total' } ], order: [[4, 'desc'], [0, 'asc'], [1, 'asc']], pageLength: 25, deferRender: true, dom: 'tip' }); const topInfo=document.getElementById('topInfo'); if(topInfo){ dataTable.on('draw', function(){ const info=dataTable.page.info(); topInfo.textContent = `Showing ${info.start+1} to ${info.end} of ${info.recordsDisplay} entries`; }); dataTable.draw(); } bindRowClicks(); }
      const meta=document.getElementById('meta'); if(meta) meta.textContent = `Loaded ${allRows.length.toLocaleString()} rows (${new Set(allRows.map(r=>r.card)).size.toLocaleString()} unique cards). Max Total = ${Math.max(1,MAX_TOTAL).toLocaleString()}.`;
    }

    function bindRowClicks(){ jQuery('#jankTable tbody').off('click','a.cardlink'); jQuery('#jankTable tbody').on('click','a.cardlink', function(e){ e.preventDefault(); const key=this.getAttribute('data-key'); const row=allRows.find(x=>x.key===key) || null; if(!row) return; showCardModal(row); }); }

    function exportCSV(){ const v=Number(document.getElementById('thresholdNumber').value); const set=document.getElementById('setFilter').value || ''; const rows=allRows.filter(r => r.total <= v && (!set || r.set===set) && passesColorFilter(r) && passesTypeFilter(r) && passesSuperFilter(r) && passesRarityFilter(r) && passesManaFilter(r) && passesNameSearch(r)); const header=['Set','Card','Main Deck','Sideboard','Total']; const lines=[header.join(',')].concat(rows.map(r => [r.set, r.card, r.main, r.side, r.total].join(','))); const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`4HM-jank-export.csv`; a.click(); }
    function updateQuery(max){ const url=new URL(location.href); if(max!=null) url.searchParams.set('max', String(max)); history.replaceState(null,'',url); }
    async function copySharableLink(){ try{ await navigator.clipboard.writeText(location.href); alert('Sharable link copied to clipboard!'); } catch(e){ alert('Copy failed. You can manually copy the URL.'); } }

    function bindDeckTools(){ const ta=document.getElementById('deckInput'); const file=document.getElementById('deckFile'); const btn=document.getElementById('analyzeBtn'); const includeSb=document.getElementById('includeSb'); if(!btn) return; file?.addEventListener('change', async()=>{ try{ const f=file.files && file.files[0]; if(!f) return; const text=await f.text(); ta.value=text; }catch(e){ console.error(e); }}); btn.addEventListener('click', ()=>{ try{ const text=(ta.value||'').trim(); if(!text){ alert('Paste a decklist first.'); return; } const parsed=parseDeck(text); const report=scoreDeck(parsed, includeSb?.checked); renderDeckScore(report); const res=validateDeck(parsed); renderValidation(res); }catch(e){ console.error(e); showErr('Analyze failed: '+(e && e.message ? e.message : e)); alert('Analyze failed. See error box above.'); } }); }

    function parseDeck(text){ const lines=text.split(/\r?\n/); const main=new Map(); const side=new Map(); let toSide=false; for(let raw of lines){ const line=raw.trim(); if(!line) continue; if(/^side\s*board\s*:?/i.test(line)){ toSide=true; continue; } const m=line.match(/^(\d+)?\s*(.+)$/); if(!m) continue; const n=m[1]? parseInt(m[1],10):1; let name=m[2]; name=name.replace(/\[[^\]]+\]/g,'').replace(/\([^\)]*\)$/,'').trim(); const key=normName(name); const bucket=toSide? side: main; bucket.set(key, (bucket.get(key)||0) + (isFinite(n)?n:1)); } return {main, side}; }

    const THRESH_ULTRA=1, THRESH_DEEP=4, THRESH_MED=10, THRESH_LIGHT=20;
    function tierOf(total){ if(total<=THRESH_ULTRA) return 'Ultra‑Jank'; if(total<=THRESH_DEEP) return 'Deep Jank'; if(total<=THRESH_MED) return 'Medium Jank'; if(total<=THRESH_LIGHT) return 'Light Jank'; return ''; }

    function scoreDeck(parsed, includeSide){ const toRow=new Map(); const nameMap=new Map(); for(const r of allRows){ const k=normName(r.card); if(!nameMap.has(k)) nameMap.set(k,r.card); if(!toRow.has(k)) toRow.set(k,r); } function mapToArr(m){ return Array.from(m.entries()).map(([key,count])=>({key,count})); } const mainArr=mapToArr(parsed.main); const sideArr=mapToArr(parsed.side);
      const matchedMain=[]; const matchedSide=[]; for(const item of mainArr){ const row=toRow.get(item.key); if(!row) continue; matchedMain.push({ key:item.key, official:nameMap.get(item.key)||item.key, total:row.total, count:item.count }); } for(const item of sideArr){ const row=toRow.get(item.key); if(!row) continue; matchedSide.push({ key:item.key, official:nameMap.get(item.key)||item.key, total:row.total, count:item.count }); }
      const logMax=Math.log(Math.max(1,MAX_TOTAL)+1); const weight=t => 100 * (1 - (Math.log((t||0)+1) / logMax)); let copiesMain=0, raw=0; for(const m of matchedMain){ copiesMain+=m.count; raw += m.count * weight(m.total); } let rawSide=0; if(includeSide){ for(const s of matchedSide){ rawSide += s.count * weight(s.total); } }
      const deepCopies = matchedMain.filter(x => x.total <= THRESH_LIGHT).reduce((a,b)=> a + b.count, 0); const deepDensity = copiesMain ? Math.round(100 * deepCopies / copiesMain) : 0; const rawMax = 60 * 100; const baseScore = Math.max(0, Math.min(100, ((raw + (includeSide ? rawSide : 0)) / rawMax) * 100)); const bonus = Math.round(25 * Math.pow(deepDensity / 100, 1.1)); const finalScore = Math.max(0, Math.min(100, baseScore + bonus));
      const allForTop=[...matchedMain].map(x=>({name:x.official, w:weight(x.total), total:x.total, count:x.count})); allForTop.sort((a,b)=> b.w - a.w); const top10=allForTop.slice(0,10); const seen=new Set(); let ultra=0,deep=0,med=0,light=0; for(const m of matchedMain){ if(seen.has(m.key)) continue; seen.add(m.key); const t=m.total; if(t<=THRESH_ULTRA) ultra++; else if(t<=THRESH_DEEP) deep++; else if(t<=THRESH_MED) med++; else if(t<=THRESH_LIGHT) light++; }
      return { score:Math.round(finalScore), baseScore:Math.round(baseScore), bonus, deepDensity, top10, tierCounts:{ultra,deep,med,light}, copiesMain };
    }

    function renderDeckScore(r){ const scoreEl=document.getElementById('scoreValue'); const bar=document.getElementById('scoreBar'); const flavor=document.getElementById('scoreFlavor'); const badges=document.getElementById('badges'); const top=document.getElementById('topJank'); scoreEl.textContent=r.score; bar.style.width=r.score+'%'; let msg=''; if(r.score>=90) msg='🌋 The Jank is STRONG with this one.'; else if(r.score>=70) msg='🧪 Maximum spice achieved — expect the unexpected.'; else if(r.score>=50) msg='🌶️ Solidly spicy — a connoisseur’s brew.'; else if(r.score>=30) msg='🧯 Respectable heat with room to get weird.'; else msg='🛡️ More staple than spice. Dare to jank harder?'; if(r.bonus>=15) msg+=' 🧪 Dense spice pocket detected.'; flavor.textContent=msg; badges.innerHTML = `<div>🧿 <b>Ultra‑jank (≤1):</b> ${r.tierCounts.ultra}</div><div>💀 <b>Deep‑jank (≤4):</b> ${r.tierCounts.deep}</div><div>🧪 <b>Medium‑jank (≤10):</b> ${r.tierCounts.med}</div><div>🔥 <b>Light‑jank (≤20):</b> ${r.tierCounts.light}</div><div>📈 <b>Jank Density:</b> ${r.deepDensity}% of maindeck</div><div>➕ <b>Density bonus:</b> +${r.bonus} (max +25)</div><div>🧾 <b>Counted copies (main):</b> ${r.copiesMain}</div>`; top.innerHTML=''; for(const t of r.top10){ const li=document.createElement('li'); const badge=tierOf(t.total); li.innerHTML=`${t.name}${badge?`<span class="tag"> ${badge}</span>`:''}`; top.appendChild(li); } }

    function validateDeck(parsed){ return { ok:true, errors:[], mainCount:[...parsed.main.values()].reduce((a,b)=>a+b,0), sideCount:[...parsed.side.values()].reduce((a,b)=>a+b,0), leg6Distinct:0, leg5Distinct:0 }; }
    function renderValidation(res){ const status=document.getElementById('valStatus'); const list=document.getElementById('valErrors'); const counts=document.getElementById('valCounts'); list.innerHTML=''; status.innerHTML = res.ok? `<span class="valid">✅ Deck is legal for 4HM under current rules.</span>` : `<span class="invalid">⛔ Deck is NOT legal — see issues below.</span>`; for(const e of res.errors){ const li=document.createElement('li'); li.textContent=e; list.appendChild(li);} counts.innerHTML = `<span class="tag">Main: ${res.mainCount}</span><span class="tag">Side: ${res.sideCount}</span>`; }

    function typeLineText(row){ const cap=s=> s? s.split(/[\s,;]+/).filter(Boolean).map(x=>x.trim()).map(w=> w.charAt(0).toUpperCase()+w.slice(1)).join(' ') : ''; const sup=cap(row.supersStr); const typ=cap(row.typesStr); const sub=cap(row.subtypesStr); return `${[sup, typ].filter(Boolean).join(' ')}${sub? ' — '+sub : ''}` || '—'; }
    function showCardModal(row){ const name=row.card; const isBan=BANNED.has(row.key) || HARD_BANNED.has(row.key); const isRes=RESTRICTED.has(row.key) && !isBan; document.getElementById('cardTitle').textContent=name||'Card'; document.getElementById('typeLine').textContent=typeLineText(row); document.getElementById('costSet').textContent=[row.set||'', row.manaCost||''].filter(Boolean).join('  •  '); document.getElementById('cardText').textContent=(row.text||'').trim() || '(no rules text in source)'; document.getElementById('artist').textContent=row.artist? `Artist — ${row.artist}` : 'Artist — ?'; const ptEl=document.getElementById('pt'); const isCreature=row.typesSet && row.typesSet.has('creature'); if(isCreature){ ptEl.style.display=''; ptEl.textContent=`${row.power||'—'}/${row.toughness||'—'}`; } else { ptEl.style.display='none'; ptEl.textContent=''; } document.getElementById('banInfo').innerHTML = isBan? '<span class="tag banned">BANNED</span>' : (isRes? '<span class="tag restricted">Restricted</span>' : ''); document.getElementById('cardModal').classList.add('open'); }
    document.getElementById('modalClose').addEventListener('click', ()=> document.getElementById('cardModal').classList.remove('open'));
    document.getElementById('cardModal').addEventListener('click', (e)=>{ if(e.target.id==='cardModal') e.currentTarget.classList.remove('open'); });
  </script>
</body>
</html>
