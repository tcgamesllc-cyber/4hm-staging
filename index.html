<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4HM Jank-O-Meter + Deck Validator (Staging)</title>
  <meta name="robots" content="noindex,nofollow"/>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <style>
    body { font-family: "Book Antiqua", Palatino, serif; background:#fdf6e3; color:#2b1a08; }
    header { background:#f9f2dd; border-bottom:2px solid #d6b87a; text-align:center; padding:20px; }
    textarea { width:100%; min-height:180px; }
    .valid { color:green; font-weight:700; }
    .invalid { color:red; font-weight:700; }
    .errlist { margin-left:20px; }
    .tag { display:inline-block; padding:2px 6px; margin-left:4px; background:#eee; border-radius:4px; font-size:0.8em; }
  </style>
</head>
<body>
  <header>
    <h1>⚡ 4HM Jank-O-Meter + Deck Validator — STAGING ⚠️</h1>
  </header>

  <div>
    <textarea id="deckInput" placeholder="Paste your deck list here..."></textarea>
    <br>
    <button id="analyzeValidateBtn">Analyze & Validate Deck</button>
    <input type="checkbox" id="includeSb" checked> Include sideboard in score
    <div id="score">Score: --</div>
    <div id="valStatus">—</div>
    <ul id="valErrors" class="errlist"></ul>
    <div id="topJank"></div>
  </div>

  <script>
    const CARDPOOL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbTvT5tNT1w_Nqz1dL-t3muSuqzQ8UkO9ssHNZT1koEM8iVQQuY7QwGpTImtqv58zT837gLm8GZG84/pub?output=csv";

    let LEGAL_CARDS = new Map();
    let BANNED = new Set();
    let RESTRICTED = new Set();
    let LEG6PLUS = new Set();
    const BASIC_SET = new Set(["plains","island","swamp","mountain","forest"]);

    let MAX_TOTAL = 0;

    function normName(n){ return n.toLowerCase().replace(/[^a-z0-9]/g,""); }

    function parseCSV(url){
      return new Promise((resolve,reject)=>{
        Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:res=>resolve(res.data),error:reject});
      });
    }

    async function boot(){
      const pool = await parseCSV(CARDPOOL_URL);
      ingestPool(pool);
      document.getElementById('analyzeValidateBtn').addEventListener('click', ()=>{
        const deckText = document.getElementById('deckInput').value;
        const parsed = parseDeck(deckText);
        const val = validateDeck(parsed);
        renderValidation(val);
        const score = calcJankScore(parsed);
        renderScore(score);
        renderTopJank(parsed);
      });
    }

    function ingestPool(rows){
      for(const r of rows){
        const nm = normName(r.name||"");
        if(!nm) continue;
        LEGAL_CARDS.set(nm, r);
        if(String(r.banned).toLowerCase()==="true") BANNED.add(nm);
        if(String(r.restricted).toLowerCase()==="true") RESTRICTED.add(nm);
        if(String(r.leg6orMore).toLowerCase()==="true") LEG6PLUS.add(nm);
        const t = Number(r["4hmTotal"]||r.total||0);
        if(t>MAX_TOTAL) MAX_TOTAL = t;
      }
    }

    function parseDeck(text){
      const lines=text.split(/\r?\n/);
      const main=new Map(); const side=new Map();
      let toSide=false;
      for(const raw of lines){
        const line=raw.trim(); if(!line) continue;
        if(/^side/i.test(line)){ toSide=true; continue; }
        const m=line.match(/^(\d+)?\s*(.+)$/);
        if(!m) continue;
        const count=parseInt(m[1]||"1");
        const nm=normName(m[2]);
        const bucket=toSide?side:main;
        bucket.set(nm,(bucket.get(nm)||0)+count);
      }
      return {main,side};
    }

    function validateDeck(parsed){
      const totals=new Map();
      let mainCount=0, sideCount=0;
      for(const [n,c] of parsed.main){ totals.set(n,(totals.get(n)||0)+c); mainCount+=c; }
      for(const [n,c] of parsed.side){ totals.set(n,(totals.get(n)||0)+c); sideCount+=c; }
      const errors=[];
      if(mainCount<60) errors.push(`Main deck has ${mainCount} cards (<60).`);
      if(sideCount>15) errors.push(`Sideboard has ${sideCount} cards (>15).`);

      let leg6Unique=new Set();
      for(const [nm,count] of totals){
        if(BASIC_SET.has(nm)) continue;
        if(!LEGAL_CARDS.has(nm)) { errors.push(`Not in card pool: ${nm}`); continue; }
        if(BANNED.has(nm)) errors.push(`BANNED: ${LEGAL_CARDS.get(nm).name}`);
        if(RESTRICTED.has(nm) && count>1) errors.push(`Restricted (max1): ${LEGAL_CARDS.get(nm).name} has ${count}`);
        if(!RESTRICTED.has(nm) && count>4) errors.push(`Too many copies (>4): ${LEGAL_CARDS.get(nm).name} has ${count}`);
        if(LEG6PLUS.has(nm) && count>0) leg6Unique.add(nm);
      }
      if(leg6Unique.size>2) errors.push(`6+ mana Legendary group exceeded: ${leg6Unique.size} unique (max2).`);

      return {ok:errors.length===0, errors};
    }

    function calcJankScore(parsed){
      const includeSb=document.getElementById('includeSb').checked;
      let totals=new Map();
      for(const [n,c] of parsed.main) totals.set(n,(totals.get(n)||0)+c);
      if(includeSb) for(const [n,c] of parsed.side) totals.set(n,(totals.get(n)||0)+c);
      let sum=0, count=0;
      for(const [nm,c] of totals){
        const row=LEGAL_CARDS.get(nm); if(!row) continue;
        const t=Number(row["4hmTotal"]||row.total||0);
        const weight=100*(1 - Math.log((t||0)+1)/Math.log(MAX_TOTAL+1));
        sum+=weight; count++;
      }
      return count?Math.round(sum/count):0;
    }

    function renderScore(score){
      document.getElementById('score').innerHTML=`Jank Score: ${score} / 100`;
    }

    function renderValidation(res){
      const status=document.getElementById('valStatus');
      const list=document.getElementById('valErrors');
      list.innerHTML="";
      if(res.ok) status.innerHTML='<span class="valid">✅ Deck is legal.</span>';
      else status.innerHTML='<span class="invalid">⛔ Deck is NOT legal</span>';
      for(const e of res.errors){
        const li=document.createElement('li'); li.textContent=e; list.appendChild(li);
      }
    }

    function renderTopJank(parsed){
      const includeSb=document.getElementById('includeSb').checked;
      let totals=new Map();
      for(const [n,c] of parsed.main) totals.set(n,(totals.get(n)||0)+c);
      if(includeSb) for(const [n,c] of parsed.side) totals.set(n,(totals.get(n)||0)+c);
      const arr=[];
      for(const [nm,c] of totals){
        const row=LEGAL_CARDS.get(nm); if(!row) continue;
        const t=Number(row["4hmTotal"]||row.total||0);
        const weight=100*(1 - Math.log((t||0)+1)/Math.log(MAX_TOTAL+1));
        arr.push({name:row.name,total:t,w:weight});
      }
      arr.sort((a,b)=>b.w-a.w);
      const top=arr.slice(0,10);
      const div=document.getElementById('topJank');
      div.innerHTML='<b>Top 10 Jankiest in Deck</b><ul>'+top.map(t=>`<li>${t.name} <span class="tag">${t.w.toFixed(1)}</span></li>`).join('')+'</ul>';
    }

    window.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
