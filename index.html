<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4HM Jank-O-Meter ‚Äî Themed + Mobile + Log Slider + Janki-ness Score (Staging)</title>

  <!-- Data & table libs (defer to avoid race conditions) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>

  <meta name="robots" content="noindex,nofollow" />

  <style>
    /* styles same as before */
  </style>
</head>
<body>
  <div class="ribbon">STAGING</div>
  <header>
    <h1>‚ö° 4HM Jank-O-Meter ‚ö°</h1>
    <div class="sub">Slide to set a maximum <b>Total Appearances</b>. Cards at or below the threshold are tagged as <i>Jank</i> (rarely used). Now with <b>Janki-ness Score (Beta)</b>.</div>
  </header>

  <!-- ... unchanged table panel ... -->

  <!-- JANKI-NESS SCORE PANEL -->
  <div class="panel" id="scorePanel" style="margin-top:16px;">
    <h2 style="margin:0 0 10px 0; color:#3a240a;">üß™ Janki-ness Score (Beta)</h2>
    <div class="grid">
      <div>
        <label for="deckInput" class="muted">Paste your Tolaria/Moxfield-style list here (sideboard optional):</label>
        <textarea id="deckInput" placeholder="e.g.\n4 Bayou\n2 Candelabra of Tawnos\n..."></textarea>
        <div class="small">or <input type="file" id="deckFile" accept=".txt,.dek,.dec"/> <button id="analyzeBtn" class="btn">Analyze Deck</button>
          <label style="margin-left:8px;"><input type="checkbox" id="includeSb"/> Include sideboard in score</label>
        </div>
      </div>
      <div class="score-hero">
        <div class="score-badge">
          <div><b>Janki-ness Score</b> <span id="scoreValue" class="kpi">‚Äî</span>/100</div>
          <div class="meter" aria-hidden="true"><div id="scoreBar"></div></div>
          <div id="scoreFlavor" class="small">Paste a deck to score it.</div>
        </div>
        <div class="score-badge">
          <div><b>Badges</b></div>
          <div id="badges" class="small">‚Äî</div>
        </div>
      </div>
      <div class="score-badge" style="flex:1;">
        <div><b>Top 5 Jankiest in Deck</b></div>
        <div class="legend">‚Äú<b>Weight</b>‚Äù = scaled rarity score: <span class="mono">100 √ó (1 ‚àí log(Total+1) / log(Max+1))</span>. Higher = jankier.</div>
        <ol id="topJank" class="list"></ol>
      </div>
      <div class="score-badge" style="flex:1;">
        <div><b>Unmatched / Notes</b></div>
        <ul id="notes" class="list"></ul>
      </div>
    </div>
  </div>

  <script>
    // Same CSV loading as before

    function scoreDeck(deck, includeSide){
      const nameMap = buildNameMap();
      let matchedMain=0, matchedSide=0, copiesMain=0, copiesSide=0;
      const unmatched=[];
      const weights=[];

      const process=(bucket,isSide)=>{
        for (const [name,count] of bucket){
          const key=normName(name);
          const official=nameMap.get(key);
          if(!official){unmatched.push(name);continue;}
          const row=allRows.find(r=>normName(r.card)===key);
          if(!row){unmatched.push(name);continue;}
          const w=100*(1-Math.log(row.total+1)/Math.log(MAX_TOTAL+1));
          weights.push({name:official,total:row.total,w,count});
          if(isSide) matchedSide+=count; else matchedMain+=count;
          if(isSide) copiesSide+=count; else copiesMain+=count;
        }
      };

      process(deck.main,false);
      if(includeSide) process(deck.side,true);

      // Weighted base score
      let raw=0; if(weights.length){ raw=weights.reduce((s,x)=>s+x.w,0)/weights.length; }

      // Distinct jank tiers
      const distinctUltra=new Set(weights.filter(x=>x.total<=1).map(x=>x.name)).size;
      const distinctDeep=new Set(weights.filter(x=>x.total<=4).map(x=>x.name)).size;
      const distinctMed=new Set(weights.filter(x=>x.total<=10).map(x=>x.name)).size;
      const distinctLight=new Set(weights.filter(x=>x.total<=20).map(x=>x.name)).size;

      // Deep density bonus
      const deepCopies=weights.filter(x=>x.total<=4).reduce((s,x)=>s+x.count,0);
      const density= copiesMain? Math.round(100*deepCopies/copiesMain):0;
      const bonus=Math.round(15*Math.pow(density/100,1.3));

      const final=clampNumber(Math.round(raw+bonus),0,100);

      return {score:final,raw:Math.round(raw),bonus,distinctUltra,distinctDeep,distinctMed,distinctLight,deepDensity:density,copiesMain,copiesSide,top5:weights.sort((a,b)=>a.w-b.w).slice(-5),unmatched};
    }

    function renderDeckScore(r){
      document.getElementById('scoreValue').textContent=r.score;
      document.getElementById('scoreBar').style.width=r.score+'%';
      let msg='';
      if(r.score>=90) msg='üåã The Jank is STRONG with this one.';
      else if(r.score>=70) msg='üß™ Maximum spice achieved ‚Äî expect the unexpected.';
      else if(r.score>=50) msg='üå∂Ô∏è Solidly spicy ‚Äî a connoisseur‚Äôs brew.';
      else if(r.score>=30) msg='üßØ Respectable heat with room to get weird.';
      else msg='üõ°Ô∏è More staple than spice. Dare to jank harder?';
      document.getElementById('scoreFlavor').textContent=msg;

      document.getElementById('badges').innerHTML=`
        <div class="small">Ultra-jank (‚â§1 Total): <b>${r.distinctUltra}</b></div>
        <div class="small">Deep-jank (‚â§4 Total): <b>${r.distinctDeep}</b></div>
        <div class="small">Medium-jank (‚â§10 Total): <b>${r.distinctMed}</b></div>
        <div class="small">Light-jank (‚â§20 Total): <b>${r.distinctLight}</b></div>
        <div class="small">Deep-jank density: <b>${r.deepDensity}%</b> of maindeck</div>
        <div class="small">Bonus from density: <b>+${r.bonus}</b></div>
        <div class="small">Base score (raw): <b>${r.raw}</b></div>
        <div class="small">Counted copies (main${r.copiesSide?'+side':''}): <b>${r.copiesMain}${r.copiesSide?` + ${r.copiesSide}`:''}</b></div>`;

      const top=document.getElementById('topJank');
      top.innerHTML='';
      for(const t of r.top5){
        const li=document.createElement('li');
        li.innerHTML=`${t.name} <span class="small">(Total ${t.total}, weight ${Math.round(t.w)})</span>`;
        top.appendChild(li);
      }

      const notes=document.getElementById('notes');
      notes.innerHTML='';
      if(r.unmatched.length){
        for(const n of r.unmatched){const li=document.createElement('li');li.textContent=`Unmatched: ${n}`;notes.appendChild(li);}
      }else{
        const li=document.createElement('li');li.textContent='All cards matched the dataset.';notes.appendChild(li);
      }
    }
  </script>
</body>
</html>
